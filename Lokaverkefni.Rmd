---
title: "Lokaverkefni nafn hér"
author: "Bergrós Skúladóttir, Indriði Arnaldsson & Íris Aníta Eyþórsdóttir"
output:
  prettydoc::html_pretty:
    theme : hpstr
    highlight: github
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, error = F)
```

```{css, echo=FALSE, class.output="scroll-100"}
.scroll-100 {
  max-height: 300px;
  overflow-y: auto;
  bakground-color:inherit;
}
pre[class] {
  max-height: 160px;
}
```

```{r}
library(tidyverse) #dplyr og ggplot2 tilheyra tidyverse
library(ggridges)
library(data.table)
library(gridExtra)
```

## Introduction 
In this assignment we will carry out an analysis of a dataset containing information of about 40 thousand real estates sold in Iceland from 2008 to 2018. The origin of the data can be traced to the National Registry of Iceland which performs an evaluation of housing prices every year. 

In the first part of the assignment we will explore the data visually. In the second part we will predict sale prices using x and x methods. In the third part we will predict the values of x (categorical variable) using the x and x methods. 

The dataset contains many variables, some of which have been excluded from analysis. For this assignment we will focus on data concerning the Capital Region of Iceland. The resulting dataset contains approximately 35 thousand observations and 17 variables regarding housing prices, municipality, age of construction, property type and property area among other. We have included only properties that are single-family houses or apartment buildings. 

## Reading data and cleanup
```{r}
data <- read_delim("https://www.skra.is/library/Samnyttar-skrar-/Fyrirtaeki-stofnanir/Fasteignamat-2019/gagnasafn_ib_2018.csv", ";", escape_double = FALSE, locale = locale(encoding = "ISO-8859-1"),
                                     trim_ws = TRUE)
data <- data %>% select(kdagur, nuvirdi, byggar, lyfta, ibm2, fjhaed, fjbilsk, fjbkar, fjsturt, fjklos, fjeld, fjherb, fjstof, fjgeym, matssvaedi, ibteg, svfn) %>%
  filter(matssvaedi < 1000) %>%
  mutate(lyfta = ifelse(lyfta >= 1, 1, 0)) %>%
  mutate(ibteg = ifelse(ibteg == 11, 1, 0)) %>%
  mutate_at("lyfta", factor) %>%
  mutate_at("matssvaedi", as.character) %>%
  mutate_at("ibteg", factor)
  
data$svfn <- recode_factor(data$svfn, `0000` = "Reykjavik", `1000`= "Kopavogur", `1100` = "Seltjarnarnes",`1300` = "Gardabaer", `1400` = "Hafnarfjordur", `1604` = "Mosfellsbaer")
data$kdagur <- as.Date(data$kdagur, format = "%d.%m.%Y")
data$yearkeypt <- format(data$kdagur, format="%Y")
data$age <- (as.numeric(data$yearkeypt)-data$byggar)
#number of negative values for property age - properties bought unfinished 
nrow(data[data$age<0,])
data <- select(data, -kdagur, -byggar)
data$matssvaedi <- recode_factor(data$matssvaedi, `11`="Vesturbær", `20` = "Miðbær", `25`="Miðbær", `31`="Miðbær", `70`="Melar", `72`="Melar", `75`="Skerjafjörður", `80`="Hlíðar", `85`="Kringlan", `90`="Holt", `91`="Háaleiti", `100`="Vogar", `110`="Bryggjuhverfi", `120`="Grafarvogur", `130`="Grafarvogur", `140`="Grafarvogur", `150`="Breiðholt", `160`="Breiðholt", `161`="Breiðholt", `170`="Breiðholt", `180`="Grafarholt", `181`="Úlfarsdalur", `200`="Árbær", `210`="Árbær", `220`="Selás", `270`="Norðlingaholt", `280`="Fossvogur", `281`="Fossvogur", `282` ="Fossvogur", `283`="Fossvogur", `284`="Fossvogur", `290`="Kjalarnes",
                                 `300`="Kóp:Vesturbær",`320`="Kóp:Austurbær",`330`="Kóp:Smárar", `340`="Kóp:Lindir", `350`="Kóp:Hvörf",`351`="Kóp:Kórar",
                                 `400`="Seltjarnarnes", `500`="Garðabær", `510`="Garðabær", `511`="Garðabær", `520`="Grb:Sjáland", `530`="Grb:Akrar", `540`="Grb:Ásar", `550`="Garðabær", `560`="Grb:Arnarnes", `590`="Garðabær",`700`="Álftanes", `600`="Hafnarfjörður", `620`="Hfj:Holt", `630`="Hfj:Vellir", `640`="Hfj:Ásland", `650`="Hfj:Setberg", `660`="Hfj:Flensborg", `670`="Hfj:Vellir", `680`="Hfj:Holt", `800`="Mosfellsbær", `810`="Mosfellsbær", `820`="Mosfellsbær", `830`="Mosfellsbær", `840`="Mosfellsbær", `850`="Mosfellsbær", `890`="Mosfellsbær", `999`="Annað")
```

## Exploratory Analysis

In this part we will explore the data. Property price is an important variable in our dataset and we are interested in exploring the relationship it has with the other variables in our data set. 

```{r, fig.align='center'}
#color theme
ColorsDT <-  data.table(Group=LETTERS[1:50], Color=c("#e0bba8","#d6a78e","#cd9274", "#c37e59","#b86a41","#9d5b38","#834c2f","#693c25","#4e2d1c","#341e12","#efc699","#eab57a", "#e5a45b","#e1923c","#d88121","#b96e1c","#9a5c17","#7b4912","#5c370e","#3d2409","#d6bdb2", "#caa99a","#bd9583","#b1816c","#a36e56","#8c5e4a","#744e3d","#5d3f31","#462f25","#2e1f18", "#e8bda0","#e1a983","#da9566","#d48149","#ca6e2f","#ad5e28","#904e22","#733f1b","#562f14", "#391f0d","#d9bfae","#ceab96","#c3987d","#b88465","#aa714e","#926143","#7a5138","#61412d", "#493021","#302016"), key="Group")
set.seed(4)
#núvirði skoðað útfrá:

#(1)svfn
f1 <- data %>% ggplot(aes(x=nuvirdi,y=svfn, fill=svfn)) +
  geom_density_ridges_gradient() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), legend.position = "none") + 
  ggtitle("Figure 1: Property price based on municipality and neighbourhood") + 
  xlim(c(0,100000)) + 
  scale_fill_manual(values=sample(ColorsDT$Color)) + 
  labs(y = " ", x = "Property Price")

#(2)matssvaedi
f2 <- data %>% ggplot(aes(x=nuvirdi,y=matssvaedi, fill=svfn)) +
  geom_density_ridges_gradient() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), legend.position = "none") + 
  ggtitle(" ") + xlim(c(0,100000)) + scale_fill_manual(values=sample(ColorsDT$Color)) + 
  labs(y = " ", x = "Property Price")
grid.arrange(f1,f2,nrow=1)
```

In figure 1 we see the property prices based on the municipality on the one hand, and neighbourhood on the other. Overall, the property prices seem to have a fairly normal distribution across the municipalities. Property prices in Reykjavík appear to be the lowest, perhaps because the properties are smaller. The prices for properties in two neighbourhoods in Garðabær and in Hlíðar appear to be, on average, higher than other neighbourhoods in our dataset. 

```{r, fig.align = 'center'}
#(3)yearkeypt
ggplot(data) + geom_bar(aes(y=nuvirdi,x=yearkeypt, fill=yearkeypt), stat="summary", fun.y="mean", position = "dodge") +
  scale_fill_manual(values=sample(ColorsDT$Color)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "gray"), legend.position = "none") + 
  geom_hline(yintercept=mean(data$nuvirdi), col = '#7b4912', size=1) + 
  ggtitle("Figure 2: Mean property price by year of sale") + labs(x= "Sales year", y= "Mean Property Price") + 
  coord_flip()
```

In figure 2 we can see the mean property price by year of sale. The vertical line represents the mean property price over the years 2012 to 2018. Property prices have gradually increased over the years.  

```{r, fig.align = 'center'}
#(4)fj breytunar
ff <- function(x){
  ggplot(data, aes(y=nuvirdi,x=as.factor(x), fill=as.factor(x))) + 
    geom_col() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), 
          legend.position = "none") + 
    ggtitle(" ") + ylim(c(0,100000)) + 
    scale_fill_manual(values=sample(ColorsDT$Color))
}
grid.arrange(ff(data$fjhaed)+ 
               labs(x = "Floors", y = " "), ff(data$fjbilsk) + 
               labs(x = "Parking spaces", y = " "), ff(data$fjbkar) + 
               labs(x = "Baths", y = " "), ff(data$fjsturt) + 
               labs(x = "Showers", y = " "), ff(data$fjklos) + 
               labs(x = "Toilets", y = " "), ff(data$fjeld) + 
               labs(x = "Kitchens", y = " "), ff(data$fjherb) + 
               labs(x = "Rooms", y = " "), ff(data$fjstof) + 
               labs(x = "Living Rooms", y = " "), ff(data$fjgeym) + 
               labs(x = "Storage Rooms", y = " "))
```

Here above we see plots of property price according to various property attributes. For example, properties that have 5 toilets are more expensive than those with fewer toilets, and properties with 3 kitchens appear to be the most expensive. 

```{r, fig.align = 'center'}
#(5)íbuðir með/án lyftu (bara fjölbýlishús)
# búum til nýtt gagnasafn sem inniheldur bara fjölbýlishús
data_fjolbylishus <- data %>% filter(ibteg == 0) %>%
  mutate(lyfta = ifelse(lyfta == 1, "Yes", "No"))

  ggplot(data_fjolbylishus) + geom_bar(aes(x=nuvirdi,y=lyfta, fill=lyfta), stat= "summary", fun.y= "mean", position = "dodge") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), 
        legend.position = "none") + 
  ggtitle("Figure 3: Property prices for apartment buildings with/without an elevator") + 
  xlim(c(0, 40000)) + 
  scale_fill_manual(values=sample(ColorsDT$Color)) + 
  labs(y = " ", x = "Property Price")
```

LAGA - súlurnar minnka þegar maður minnkar x-ásinn. Fara alltaf neðar og neðar af einhverri ástæðu. 

In figure 3 we see the average property price of apartment buildings based on whether the building has an elevator or not. Apartment buildings with elevators are on average more expensive.  

```{r, fig.align = 'center'}
# verð út frá aldri byggingar og tegund húsnæðis.
f3 <- data %>% 
  mutate(ibteg=ifelse(data$ibteg == 1, "Single-family house", "Apartment building"))

ggplot(f3, aes(x=nuvirdi,y=age, group = ibteg, color = ibteg)) +
  geom_smooth() + 
  ggtitle("Figure 4: Property price based on age and type of property") +
  labs(x = "Property price", y = "Age of property") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
   xlim(c(0,100000)) + 
  scale_fill_manual(values = sample(ColorsDT$Color)) + 
  scale_color_manual(name = "Type of property",values = sample(ColorsDT$Color))
```

In figure 4 we have the average property price based on age and type of property. Single-family houses are on average more expensive than apartment buildings and the older the property the more inexpensive it is. Age appears to be irrelevant for single-family houses priced 50 million isk and above.   

```{r, fig.align = 'center'}
# price per square meter by municipality
data <- data %>% 
  mutate(fermetraverd = nuvirdi/ibm2)

ggplot(data, aes(x = fermetraverd, y = svfn, fill = svfn)) +
  geom_density_ridges_gradient() +
  labs(x= "Price per square meter", y = "Municipality") +
  ggtitle("Figure 5: Price per square meter by municipality") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), legend.position = "none") + 
  scale_fill_manual(values = sample(ColorsDT$Color)) + 
  scale_color_manual(name = "Type of property",values=sample(ColorsDT$Color)) +
  xlim(c(0, 75))
```

In figure 5 we see price per square meter by municipality. We can gather that prices per square meter are a bit higher for properties in Garðabær and Seltjarnarnes (and Mosfellsbær to a degree) than for properties in the other municipalities. 
